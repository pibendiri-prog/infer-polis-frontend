<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infer-Polis v10.2.9 â€” Enterprise Policy Intelligence</title>

  <!-- CSP: allow blob scripts + allow backend calls -->
  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      base-uri 'self';
      object-src 'none';
      frame-ancestors 'self';

      script-src 'self' blob: 'wasm-unsafe-eval' 'unsafe-inline';
      script-src-elem 'self' blob: 'unsafe-inline';

      style-src 'self' 'unsafe-inline';

      img-src 'self' data: blob:;
      font-src 'self' data:;

      worker-src 'self' blob:;
      connect-src 'self' https://infer-polis.onrender.com;
      form-action 'self';
      upgrade-insecure-requests;
    "
  />

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --text: #e9eefc;
      --muted:#a8b3d1;
      --accent:#7c5cff;
      --accent2:#39d98a;
      --danger:#ff5c7a;
      --warn:#ffcc66;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(57,217,138,.12), transparent 55%),
        radial-gradient(700px 500px at 50% 90%, rgba(255,204,102,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      padding: 26px 18px 70px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    header{display:flex;gap:18px;align-items:center;justify-content:space-between;margin-bottom:18px;}
    .brand{display:flex;gap:14px;align-items:center;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(57,217,138,.7));
      box-shadow: 0 14px 40px rgba(124,92,255,.15);
      border:1px solid rgba(255,255,255,.18);
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px;line-height:1.25;}
    .subtitle{margin-top:2px;color:var(--muted);font-size:13px;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background: var(--warn);box-shadow: 0 0 0 4px rgba(255,204,102,.12);}
    .grid{display:grid;grid-template-columns: 1.15fr .85fr;gap:18px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}}
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .top{
      padding: 16px 18px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .card .top h2{margin:0;font-size:14px;letter-spacing:.3px;color:#f1f5ff;}
    .card .top small{color:var(--muted);}
    .card .body{padding:16px 18px 18px;}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .row > *{flex:1}
    select,input[type="text"],input[type="file"],textarea{
      width:100%;padding:12px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(7,12,22,.55);
      color: var(--text);
      outline:none;font-size:14px;
    }
    textarea{min-height:110px;resize:vertical}
    select:focus,input:focus,textarea:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.15);
    }
    .actions{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap;align-items:center;}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:11px 14px;border-radius:12px;cursor:pointer;
      font-weight:600;letter-spacing:.2px;font-size:14px;
      display:inline-flex;align-items:center;gap:10px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.55));
      box-shadow: 0 16px 40px rgba(124,92,255,.12);
    }
    .btn.success{
      border-color: rgba(57,217,138,.55);
      background: linear-gradient(135deg, rgba(57,217,138,.8), rgba(57,217,138,.35));
      box-shadow: 0 16px 40px rgba(57,217,138,.10);
    }
    .btn.danger{border-color: rgba(255,92,122,.45);background: rgba(255,92,122,.12);}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .helper{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4;}
    .status{
      margin-top:14px;padding:12px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:none;
    }
    .status.show{display:block}
    .status .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      font-size:12px;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);color: var(--muted);white-space:nowrap;
    }
    .badge.ok{border-color: rgba(57,217,138,.45); color:#c9ffe6; background: rgba(57,217,138,.10)}
    .badge.err{border-color: rgba(255,92,122,.45); color:#ffd0d9; background: rgba(255,92,122,.10)}
    .badge.warn{border-color: rgba(255,204,102,.45); color:#ffe7b8; background: rgba(255,204,102,.10)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px;color:#dfe6ff;}
    pre{
      margin:0;padding:12px;border-radius:12px;background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      overflow:auto;max-height:360px;white-space: pre-wrap;word-break: break-word;
    }
    .split{display:grid;grid-template-columns:1fr;gap:12px;}
    .kpi{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;}
    @media (max-width:520px){.kpi{grid-template-columns:1fr}}
    .kpi .box{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);}
    .kpi .box .t{color:var(--muted);font-size:12px}
    .kpi .box .v{font-size:16px;font-weight:700;margin-top:4px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Infer-Polis v10.2.9 (Enterprise)</h1>
          <div class="subtitle">Upload PDF/CSV/TXT or Paste Text â€¢ KPI/ROI/Feasibility â€¢ Donor-grade outputs</div>
        </div>
      </div>

      <div class="pill" id="backendPill" title="Backend connectivity" role="status" aria-live="polite">
        <span class="dot" id="pillDot"></span>
        <span id="pillText">Backend: checkingâ€¦</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: AUDIT -->
      <section class="card" aria-label="Policy audit">
        <div class="top">
          <div>
            <h2>Policy Audit</h2>
            <small>Enterprise mode: uploads go to <span class="mono">/policy/audit/upload</span>; pasted text goes to <span class="mono">/policy/audit</span>.</small>
          </div>
          <small class="muted">Backend: <span class="mono">infer-polis.onrender.com</span></small>
        </div>

        <div class="body">
          <div class="row">
            <div>
              <label for="countryDropdown">Tenant / Country</label>
              <select id="countryDropdown" aria-label="Select tenant or country">
                <option value="" disabled selected>Select a tenant</option>

                <optgroup label="Organizations">
                  <option value="public">ğŸŒ Public</option>
                  <option value="afdb">ğŸ›ï¸ AfDB Global</option>
                  <option value="unicef">ğŸ’™ UNICEF Int</option>
                </optgroup>

                <optgroup label="Africa">
                  <option value="nigeria">ğŸ‡³ğŸ‡¬ Nigeria</option>
                  <option value="ghana">ğŸ‡¬ğŸ‡­ Ghana</option>
                  <option value="angola">ğŸ‡¦ğŸ‡´ Angola</option>
                  <option value="tanzania">ğŸ‡¹ğŸ‡¿ Tanzania</option>
                  <option value="eswatini">ğŸ‡¸ğŸ‡¿ Eswatini</option>
                  <option value="zambia">ğŸ‡¿ğŸ‡² Zambia</option>
                  <option value="mozambique">ğŸ‡²ğŸ‡¿ Mozambique</option>
                  <option value="malawi">ğŸ‡²ğŸ‡¼ Malawi</option>
                  <option value="kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                  <option value="uganda">ğŸ‡ºğŸ‡¬ Uganda</option>
                  <option value="rwanda">ğŸ‡·ğŸ‡¼ Rwanda</option>
                  <option value="south_africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                  <option value="namibia">ğŸ‡³ğŸ‡¦ Namibia</option>
                  <option value="botswana">ğŸ‡§ğŸ‡¼ Botswana</option>
                  <option value="cameroon">ğŸ‡¨ğŸ‡² Cameroon</option>
                  <option value="senegal">ğŸ‡¸ğŸ‡³ Senegal</option>
                  <option value="ethiopia">ğŸ‡ªğŸ‡¹ Ethiopia</option>
                  <option value="ivory_coast">ğŸ‡¨ğŸ‡® CÃ´te dâ€™Ivoire</option>
                </optgroup>
              </select>
              <div class="helper">Sent as <span class="mono">X-Tenant-ID</span> and also as <span class="mono">tenant</span> form field on upload.</div>
            </div>

            <div>
              <label for="fileInput">Policy File (PDF/CSV/TXT)</label>
              <input type="file" id="fileInput" aria-label="Upload policy file PDF or CSV or TXT" accept=".pdf,.csv,.txt" />
              <div class="helper">If file is selected, UI uses <span class="mono">multipart/form-data</span> upload endpoint.</div>
            </div>
          </div>

          <label for="promptInput">Or paste policy text (optional, overrides upload)</label>
          <textarea id="promptInput" placeholder="Paste policy or project document text here. If provided, it overrides file upload and will be sent as JSON."></textarea>

          <div class="actions">
            <button class="btn primary" id="submitButton" aria-label="Run policy audit">
              <span>Run Audit</span>
              <span class="mono" id="auditSpinner" style="display:none;">â³</span>
            </button>
            <button class="btn" id="clearAuditBtn" type="button" aria-label="Clear audit form">Clear</button>
            <span class="muted tiny" id="auditMeta" aria-live="polite"></span>
          </div>

          <div id="responseArea" class="status" role="status" aria-live="polite">
            <div class="head">
              <span class="badge warn" id="auditBadge">Awaiting</span>
              <span class="muted tiny" id="auditTime"></span>
            </div>
            <div class="split">
              <div id="auditQuick" class="kpi" style="display:none;"></div>
              <pre id="auditRaw" class="mono"></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: ADMIN + FEEDBACK -->
      <aside class="card" aria-label="Admin and feedback">
        <div class="top">
          <div>
            <h2>Admin & Feedback</h2>
            <small>Set API key once in this browser.</small>
          </div>
          <small class="muted">Header: <span class="mono">X-API-Key</span></small>
        </div>

        <div class="body">
          <label for="apiKeyInput">API Key (stored locally)</label>
          <input type="text" id="apiKeyInput" aria-label="Enter API key" placeholder="ipk_â€¦" autocomplete="off" />
          <div class="actions">
            <button class="btn success" id="saveApiKeyButton" type="button">Save Key</button>
            <button class="btn danger" id="clearApiKeyButton" type="button">Clear Key</button>
          </div>
          <div class="helper" id="keyStatus">Status: <span class="mono">No key saved</span></div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:16px 0">

          <div class="helper">
            Enterprise rules:
            <ul>
              <li>If you paste text â†’ sends JSON to <span class="mono">/policy/audit</span></li>
              <li>If you choose a file â†’ uploads FormData to <span class="mono">/policy/audit/upload</span></li>
              <li>403 means your key is not permitted for that tenant</li>
              <li>400 Unknown tenant means backend tenant registry needs that ID</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const BACKEND_BASE = "https://infer-polis.onrender.com";

    const $ = (id) => document.getElementById(id);
    const nowTime = () => new Date().toLocaleString();

    function showStatus(areaId, show=true){
      const el = $(areaId);
      el.classList.toggle("show", show);
      el.style.display = show ? "block" : "none";
    }

    function setBadge(badgeEl, type, text){
      badgeEl.className = "badge " + type;
      badgeEl.textContent = text;
    }

    function safePretty(text){
      try { return JSON.stringify(JSON.parse(text), null, 2); }
      catch { return text; }
    }

    function extractQuickMetrics(text){
      try {
        const obj = JSON.parse(text);
        const a = obj.audit ?? obj;

        const rs = a.readiness_score ?? a.readiness ?? a.scores?.readiness_score;
        const fb = a.feasibility_band ?? a.band ?? a.verdict?.feasibility_band;
        const vd = a.verdict ?? a.decision ?? a.scores?.verdict;

        return { rs, fb, vd };
      } catch {
        return null;
      }
    }

    // API KEY storage
    function getApiKey(){ return (localStorage.getItem("ip_api_key") || "").trim(); }
    function setApiKey(key){ localStorage.setItem("ip_api_key", (key || "").trim()); }
    function clearApiKey(){ localStorage.removeItem("ip_api_key"); }
    function updateKeyUI(){
      const key = getApiKey();
      $("keyStatus").innerHTML = key
        ? `Status: <span class="mono">Key saved âœ“</span>`
        : `Status: <span class="mono">No key saved</span>`;
    }

    // Backend health check
    async function checkBackend(){
      const pillText = $("pillText");
      const dot = $("pillDot");

      try{
        const res = await fetch(`${BACKEND_BASE}/`, { method:"GET" });
        if (!res.ok) throw new Error("Not OK");
        dot.style.background = "var(--accent2)";
        dot.style.boxShadow = "0 0 0 4px rgba(57,217,138,.12)";
        pillText.textContent = "Backend: online";
      }catch(e){
        dot.style.background = "var(--danger)";
        dot.style.boxShadow = "0 0 0 4px rgba(255,92,122,.12)";
        pillText.textContent = "Backend: offline / CORS / URL issue";
      }
    }

    // INIT
    updateKeyUI();
    checkBackend();

    $("saveApiKeyButton").onclick = () => {
      const v = $("apiKeyInput").value.trim();
      if (!v){ alert("Paste your API key first (ipk_â€¦)."); return; }
      setApiKey(v);
      $("apiKeyInput").value = "";
      updateKeyUI();
      alert("API key saved locally in this browser.");
    };

    $("clearApiKeyButton").onclick = () => {
      clearApiKey();
      updateKeyUI();
      alert("API key cleared.");
    };

    $("clearAuditBtn").onclick = () => {
      $("fileInput").value = "";
      $("promptInput").value = "";
      $("auditMeta").textContent = "";
      $("auditRaw").textContent = "";
      $("auditQuick").innerHTML = "";
      $("auditQuick").style.display = "none";
      showStatus("responseArea", false);
    };

    $("submitButton").onclick = async () => {
      const tenant = $("countryDropdown").value;
      const fileInput = $("fileInput");
      const apiKey = getApiKey();
      const manualPrompt = ($("promptInput").value || "").trim();
      const hasFile = !!(fileInput.files && fileInput.files.length);

      $("auditMeta").textContent = "";
      $("auditRaw").textContent = "";
      $("auditQuick").innerHTML = "";
      $("auditQuick").style.display = "none";
      showStatus("responseArea", false);

      if (!tenant){
        showStatus("responseArea", true);
        setBadge($("auditBadge"), "warn", "Missing tenant");
        $("auditTime").textContent = nowTime();
        $("auditRaw").textContent = "Please select a tenant/country first.";
        return;
      }
      if (!apiKey){
        showStatus("responseArea", true);
        setBadge($("auditBadge"), "warn", "No API key");
        $("auditTime").textContent = nowTime();
        $("auditRaw").textContent = "Save your API key first (Admin panel).";
        return;
      }
      if (!manualPrompt && !hasFile){
        showStatus("responseArea", true);
        setBadge($("auditBadge"), "warn", "Missing input");
        $("auditTime").textContent = nowTime();
        $("auditRaw").textContent = "Paste text OR select a file (PDF/CSV/TXT).";
        return;
      }

      const btn = $("submitButton");
      btn.disabled = true;
      $("auditSpinner").style.display = "inline";
      setBadge($("auditBadge"), "warn", "Runningâ€¦");
      $("auditTime").textContent = nowTime();
      showStatus("responseArea", true);

      try{
        let res, text;

        // MODE 1: Manual prompt overrides file => JSON endpoint
        if (manualPrompt){
          $("auditMeta").textContent = "Sending JSON promptâ€¦";
          res = await fetch(`${BACKEND_BASE}/policy/audit`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": apiKey,
              "X-Tenant-ID": tenant
            },
            body: JSON.stringify({ prompt: manualPrompt })
          });
          text = await res.text();
        }

        // MODE 2: File selected => Read file (txt/csv) and send as JSON to /policy/audit
else {
  const file = fileInput.files[0];

  const ext = (file.name.split(".").pop() || "").toLowerCase();

  if (ext === "pdf") {
    throw new Error(
      "PDF upload is not supported in this static HTML build yet. " +
      "Please paste the extracted policy text into the textarea, or convert the PDF to text/CSV."
    );
  }

  if (ext !== "txt" && ext !== "csv") {
    throw new Error("Unsupported file type. Please use TXT or CSV, or paste text.");
  }

  $("auditMeta").textContent = `Reading file: ${file.name} (${Math.round(file.size/1024)} KB)â€¦`;

  const fileText = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result || ""));
    reader.onerror = () => reject(new Error("Failed to read file in browser."));
    reader.readAsText(file);
  });

  const combinedPrompt =
    `POLICY DOCUMENT (${file.name})\n\n` +
    fileText;

  $("auditMeta").textContent = `Sending file content as JSON promptâ€¦`;

  res = await fetch(`${BACKEND_BASE}/policy/audit`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-API-Key": apiKey,
      "X-Tenant-ID": tenant
    },
    body: JSON.stringify({ prompt: combinedPrompt })
  });

  text = await res.text();
}


        if (!res.ok) {
          let msg = text || res.statusText || "Request failed";
          if (res.status === 400) msg = "Bad request: unknown tenant or invalid input.";
          if (res.status === 401) msg = "Unauthorized: API key missing or invalid.";
          if (res.status === 403) msg = "Forbidden: your key is not permitted for this tenant.";
          if (res.status === 413) msg = "Payload too large: reduce file size or test with smaller CSV/TXT.";
          if (res.status === 415) msg = "Unsupported media type: use PDF/CSV/TXT or paste text.";
          if (res.status === 422) msg = "Validation error: backend rejected input format.";
          if (res.status >= 500) msg = "Server error: check Render backend logs.";
          throw new Error(msg);
        }

        setBadge($("auditBadge"), "ok", "Success");
        $("auditTime").textContent = nowTime();
        $("auditRaw").textContent = safePretty(text);

        const quick = extractQuickMetrics(text);
        if (quick){
          const { rs, fb, vd } = quick;
          const quickEl = $("auditQuick");
          quickEl.style.display = "grid";
          quickEl.innerHTML = `
            <div class="box">
              <div class="t">Readiness Score</div>
              <div class="v">${(rs ?? "â€”")}</div>
            </div>
            <div class="box">
              <div class="t">Feasibility Band</div>
              <div class="v">${(fb ?? "â€”")}</div>
            </div>
            <div class="box">
              <div class="t">Verdict</div>
              <div class="v">${(typeof vd === "string" ? vd : (vd?.verdict ?? "â€”"))}</div>
            </div>
          `;
        }

     }catch(err){
  setBadge($("auditBadge"), "err", "Error");
  $("auditTime").textContent = nowTime();

  $("auditRaw").textContent =
    "Request failed.\n\n" +
    (err?.message || String(err)) +
    "\n\nMode logic:\n" +
    "- If text is pasted => JSON /policy/audit\n" +
    "- If TXT/CSV file selected => read in browser and send as JSON /policy/audit\n" +
    "- If PDF selected => paste extracted text (PDF upload not enabled yet)\n";
}

      }finally{
        btn.disabled = false;
        $("auditSpinner").style.display = "none";
      }
    };
  </script>
</body>
</html>
