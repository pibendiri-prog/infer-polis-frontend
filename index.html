<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infer-Polis 11.0 ‚Äî Policy Audit</title>

  <style>
    :root { --bg:#0b1220; --card:#0f1b33; --muted:#9fb0d0; --text:#e9f0ff; --line:#22345b; --good:#35c46a; --warn:#ffcc66; --bad:#ff5c5c; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ padding:18px 22px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;}
    header h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 22px 40px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media(min-width:1100px){ .grid{ grid-template-columns: 420px 1fr; } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, select, textarea{
      width:100%; box-sizing:border-box; padding:10px 11px;
      border-radius:10px; border:1px solid #243a68; background:#09152d; color:var(--text);
      outline:none;
    }
    textarea{ min-height:170px; resize:vertical; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      cursor:pointer; border:1px solid #2b4782; background:#0a1b3d; color:var(--text);
      padding:10px 12px; border-radius:10px; font-weight:600;
    }
    .btn:hover{ border-color:#3c62b3; }
    .btn.primary{ background:#11346e; border-color:#3867c9; }
    .btn.dl{ background:#0f2b56; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#09152d; }
    .pill .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; }
    .muted{ color:var(--muted); }
    pre{
      background:#071127; border:1px solid #20335a; padding:10px; border-radius:12px; overflow:auto;
      white-space:pre-wrap; word-break:break-word;
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top; }
    th{ color:var(--muted); font-weight:600; }
    .small{ font-size:12px; }
    .two{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media(min-width:1100px){ .two{ grid-template-columns:1fr 1fr; } }
    .err{ color:#ffb4b4; }
    .ok{ color:#b7ffc9; }
    .badge{ font-weight:700; }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35; }
    .charts{ display:grid; gap:12px; grid-template-columns: 1fr; margin-top:12px; }
    @media(min-width:1100px){ .charts{ grid-template-columns: 1fr 1fr; } }
    .chartCard{
      background:#071127; border:1px solid #20335a; border-radius:12px; padding:10px;
    }
    .chartTitle{ font-size:12px; color:var(--muted); margin:0 0 6px; }
    canvas{ width:100% !important; height:260px !important; }
  </style>

  <!-- Charts: Chart.js (CDN). If your CSP blocks this, see CSP note at bottom. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
<header>
  <h1>Infer-Polis 11.0 ‚Äî Sovereign Governance Decision Engine</h1>
  <div class="row">
    <span class="pill"><span class="dot" id="dotLive" style="background:#666"></span><span id="liveText">Not checked</span></span>
    <span class="pill">Backend: <span class="badge" id="backendVer">‚Äî</span></span>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: Controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted small">API base</div>
          <div class="small"><code id="baseUrlLabel"></code></div>
        </div>
        <button class="btn" id="btnPing">Check Live</button>
      </div>

      <label>Tenant</label>
      <select id="tenantSelect"></select>

      <label>API Key (X-API-Key)</label>
      <input id="apiKey" placeholder="ipk_..." autocomplete="off"/>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="btnRun">Run Audit (Paste)</button>
        <button class="btn primary" id="btnUpload">Upload & Audit</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>

      <label style="margin-top:14px;">Policy Prompt (Paste Mode)</label>
      <textarea id="prompt" placeholder="Paste policy text here..."></textarea>

      <label style="margin-top:12px;">Upload File (Upload Mode)</label>
      <input id="fileInput" type="file" accept=".txt,.md,.pdf,.docx,.csv,text/plain,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/markdown,text/csv"/>
      <div class="hint">
        Supported: TXT/MD/CSV (full text download support), PDF/DOCX (audit works, but report download needs backend support).<br/>
        Upload uses <code>/policy/audit/upload</code> (multipart).
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn dl" id="btnPdf" disabled>Download PDF</button>
        <button class="btn dl" id="btnCsv" disabled>Download CSV</button>
        <button class="btn" id="btnCopyJson" disabled>Copy JSON</button>
      </div>

      <div class="muted small" style="margin-top:10px;">
        Tip: Use <code>output_mode: both</code> so you get <code>human_view</code> + JSON.
      </div>

      <div id="status" class="small" style="margin-top:12px;"></div>

      <div class="hint" style="margin-top:12px;">
        If charts or downloads don‚Äôt work, open DevTools ‚Üí Console/Network and check for CSP/CORS errors.
      </div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="muted small">Latest Audit</div>
          <div class="small">audit_id: <code id="auditId">‚Äî</code></div>
        </div>
        <div class="row">
          <span class="pill"><span class="dot" id="bandDot" style="background:#666"></span><span id="bandText">‚Äî</span></span>
          <span class="pill">Readiness: <span class="badge" id="readiness">‚Äî</span></span>
          <span class="pill">RoG: <span class="badge" id="rog">‚Äî</span></span>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts">
        <div class="chartCard">
          <p class="chartTitle">KPI Scores (Bar)</p>
          <canvas id="chartKpiBar"></canvas>
        </div>
        <div class="chartCard">
          <p class="chartTitle">Stress Test Readiness (Line)</p>
          <canvas id="chartStressLine"></canvas>
        </div>
        <div class="chartCard" style="grid-column:1/-1;">
          <p class="chartTitle">KPI Score Distribution (Histogram)</p>
          <canvas id="chartKpiHist"></canvas>
        </div>
      </div>

      <h3 style="margin:14px 0 6px; font-size:14px;">Policymaker View (human_view)</h3>
      <pre id="humanView">‚Äî</pre>

      <div class="two">
        <div>
          <h3 style="margin:10px 0 6px; font-size:14px;">Minister Brief</h3>
          <pre id="ministerBrief">‚Äî</pre>
        </div>
        <div>
          <h3 style="margin:10px 0 6px; font-size:14px;">Donor Compliance</h3>
          <pre id="donorCompliance">‚Äî</pre>
        </div>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Executive Verdict (Memo)</h3>
      <pre id="execVerdict">‚Äî</pre>

      <h3 style="margin:10px 0 6px; font-size:14px;">KPI Scores (21 domains)</h3>
      <div style="max-height:320px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
        <table id="kpiTable">
          <thead><tr><th>Domain</th><th>Score</th><th>Evidence</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Stress Tests</h3>
      <div style="max-height:260px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
        <table id="stressTable">
          <thead><tr><th>Scenario</th><th>Readiness</th><th>Band</th><th>Verdict</th><th>RoG</th><th>FR</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Raw JSON (audit)</h3>
      <pre id="rawJson">‚Äî</pre>
    </div>

  </div>
</div>

<script>
(() => {
  // =========================
  // CONFIG
  // =========================
  const BASE_URL = "https://infer-polis.onrender.com";   // backend
  document.getElementById("baseUrlLabel").textContent = BASE_URL;

  const el = (id) => document.getElementById(id);

  const dotLive = el("dotLive");
  const liveText = el("liveText");
  const backendVer = el("backendVer");
  const tenantSelect = el("tenantSelect");
  const apiKeyInput = el("apiKey");
  const promptInput = el("prompt");
  const fileInput = el("fileInput");

  const statusEl = el("status");
  const auditIdEl = el("auditId");
  const bandDot = el("bandDot");
  const bandText = el("bandText");
  const readinessEl = el("readiness");
  const rogEl = el("rog");

  const humanViewEl = el("humanView");
  const ministerBriefEl = el("ministerBrief");
  const donorComplianceEl = el("donorCompliance");
  const execVerdictEl = el("execVerdict");
  const rawJsonEl = el("rawJson");

  const kpiTbody = el("kpiTable").querySelector("tbody");
  const stressTbody = el("stressTable").querySelector("tbody");

  const btnRun = el("btnRun");
  const btnUpload = el("btnUpload");
  const btnClear = el("btnClear");
  const btnPing = el("btnPing");
  const btnPdf = el("btnPdf");
  const btnCsv = el("btnCsv");
  const btnCopyJson = el("btnCopyJson");

  let lastPrompt = "";
  let lastTenant = "";
  let lastApiKey = "";
  let lastAudit = null;

  // Charts
  let chartKpiBar = null;
  let chartStressLine = null;
  let chartKpiHist = null;

  // =========================
  // UI helpers
  // =========================
  function setStatus(msg, ok=true){
    statusEl.innerHTML = ok ? `<span class="ok">${escapeHtml(msg)}</span>` : `<span class="err">${escapeHtml(msg)}</span>`;
  }

  function bandColor(b){
    if (b === "GREEN") return "var(--good)";
    if (b === "AMBER") return "var(--warn)";
    if (b === "RED") return "var(--bad)";
    return "#666";
  }

  function setBusy(isBusy){
    btnRun.disabled = isBusy;
    btnUpload.disabled = isBusy;
    btnPing.disabled = isBusy;
    btnClear.disabled = isBusy;
    document.body.style.cursor = isBusy ? "progress" : "default";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function fmtNum(x, d){
    if (x === null || x === undefined) return "";
    const n = Number(x);
    if (Number.isNaN(n)) return String(x);
    return n.toFixed(d);
  }

  function clearOutput(){
    auditIdEl.textContent = "‚Äî";
    bandText.textContent = "‚Äî";
    bandDot.style.background = "#666";
    readinessEl.textContent = "‚Äî";
    rogEl.textContent = "‚Äî";
    humanViewEl.textContent = "‚Äî";
    ministerBriefEl.textContent = "‚Äî";
    donorComplianceEl.textContent = "‚Äî";
    execVerdictEl.textContent = "‚Äî";
    rawJsonEl.textContent = "‚Äî";
    kpiTbody.innerHTML = "";
    stressTbody.innerHTML = "";
    btnPdf.disabled = true;
    btnCsv.disabled = true;
    btnCopyJson.disabled = true;
    lastAudit = null;

    // clear charts
    destroyCharts();
  }

  function destroyCharts(){
    if (chartKpiBar) { chartKpiBar.destroy(); chartKpiBar = null; }
    if (chartStressLine) { chartStressLine.destroy(); chartStressLine = null; }
    if (chartKpiHist) { chartKpiHist.destroy(); chartKpiHist = null; }
  }

  // =========================
  // Data helpers
  // =========================
  async function readFileAsText(file){
    const name = (file?.name || "").toLowerCase();
    const isTextLike = name.endsWith(".txt") || name.endsWith(".md") || name.endsWith(".csv");
    if (!isTextLike) return null;
    return await file.text();
  }

  function canDownloadReport(){
    // We only generate report from prompt in this frontend
    return Boolean((lastPrompt || "").trim());
  }

  function updateDownloadButtons(){
    const ok = canDownloadReport();
    btnPdf.disabled = !ok;
    btnCsv.disabled = !ok;
  }

  // =========================
  // Backend calls
  // =========================
  async function ping(){
    try{
      const r = await fetch(`${BASE_URL}/`);
      const j = await r.json();
      const ver = j?.version || "unknown";
      backendVer.textContent = ver;
      dotLive.style.background = r.ok ? "var(--good)" : "var(--bad)";
      liveText.textContent = r.ok ? "Service live" : "Service issue";
      setStatus(`Backend OK: ${ver}`, true);
    }catch(e){
      dotLive.style.background = "var(--bad)";
      liveText.textContent = "Offline";
      setStatus(`Backend unreachable: ${e.message}`, false);
    }
  }

  async function loadTenants(){
    try{
      const r = await fetch(`${BASE_URL}/tenants`);
      const j = await r.json();
      const items = j?.tenants || [];
      tenantSelect.innerHTML = "";
      for (const t of items){
        const opt = document.createElement("option");
        opt.value = t.tenant_id;
        opt.textContent = `${t.label} (${t.tenant_id})`;
        tenantSelect.appendChild(opt);
      }
      tenantSelect.value = "public";
    }catch(e){
      tenantSelect.innerHTML = `<option value="public">üåç Public (public)</option>`;
      tenantSelect.value = "public";
    }
  }

  async function runAuditPaste(){
    const tenantId = tenantSelect.value;
    const apiKey = apiKeyInput.value.trim();
    const promptText = (promptInput.value || "").trim();

    if (!apiKey) return setStatus("API key required.", false);
    if (!promptText || promptText.length < 10) return setStatus("Prompt too short.", false);

    setBusy(true);
    setStatus("Running paste audit‚Ä¶", true);
    clearOutput();

    lastPrompt = promptText;
    lastTenant = tenantId;
    lastApiKey = apiKey;

    try{
      const r = await fetch(`${BASE_URL}/policy/audit`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey,
          "X-Tenant-ID": tenantId
        },
        body: JSON.stringify({
          prompt: promptText,
          output_mode: "both"
        })
      });

      const j = await r.json();
      if (!r.ok || !j.ok){
        throw new Error(j?.detail ? JSON.stringify(j.detail) : (j?.error || "Audit failed"));
      }

      lastAudit = j;
      renderAudit(j);
      setStatus("Paste audit complete.", true);

      btnCopyJson.disabled = false;
      updateDownloadButtons();

    }catch(e){
      setStatus(`Paste audit error: ${e.message}`, false);
    }finally{
      setBusy(false);
    }
  }

  async function runAuditUpload(){
    const tenantId = tenantSelect.value;
    const apiKey = apiKeyInput.value.trim();
    const f = fileInput.files && fileInput.files[0];

    if (!apiKey) return setStatus("API key required.", false);
    if (!tenantId) return setStatus("Tenant required.", false);
    if (!f) return setStatus("Choose a file first (TXT/MD/CSV/PDF/DOCX).", false);

    lastTenant = tenantId;
    lastApiKey = apiKey;

    // Capture text prompt for downloads (TXT/MD/CSV only)
    const maybeText = await readFileAsText(f);
    lastPrompt = (maybeText && maybeText.trim().length > 10) ? maybeText.trim() : "";

    setBusy(true);
    setStatus(`Uploading "${f.name}" and running audit‚Ä¶`, true);
    clearOutput();

    try{
      const fd = new FormData();
      fd.append("tenant", tenantId);
      fd.append("output_mode", "both");
      fd.append("file", f, f.name);

      const r = await fetch(`${BASE_URL}/policy/audit/upload`, {
        method: "POST",
        headers: {
          "X-API-Key": apiKey,
          "X-Tenant-ID": tenantId
        },
        body: fd
      });

      const j = await r.json();
      if (!r.ok || !j.ok){
        throw new Error(j?.detail ? JSON.stringify(j.detail) : (j?.error || "Upload audit failed"));
      }

      lastAudit = j;
      renderAudit(j);

      btnCopyJson.disabled = false;
      updateDownloadButtons();

      if (!canDownloadReport()){
        setStatus(
          "Upload audit complete. Note: PDF/CSV download needs a prompt. Use Paste mode OR upload TXT/MD/CSV. (PDF/DOCX text extraction needs backend support.)",
          true
        );
      } else {
        setStatus("Upload audit complete. Downloads enabled (text-based upload).", true);
      }

    }catch(e){
      setStatus(`Upload audit error: ${e.message}`, false);
    }finally{
      setBusy(false);
    }
  }

  async function downloadReport(fmt){
    const tenantId = lastTenant || tenantSelect.value;
    const apiKey = lastApiKey || apiKeyInput.value.trim();
    const promptText = (lastPrompt || (promptInput.value || "").trim());

    if (!apiKey) return setStatus("API key required.", false);
    if (!promptText) return setStatus("Paste a prompt (or upload TXT/MD/CSV) for report generation.", false);

    try{
      setStatus(`Generating ${fmt.toUpperCase()}‚Ä¶`, true);

      const r = await fetch(`${BASE_URL}/report/generate?format=${encodeURIComponent(fmt)}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey,
          "X-Tenant-ID": tenantId
        },
        body: JSON.stringify({ prompt: promptText })
      });

      if (!r.ok) {
        const t = await r.text().catch(()=> "");
        throw new Error(`Report generation failed (${r.status}). ${t.slice(0,140)}`);
      }

      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `infer-polis-report.${fmt === "csv" ? "csv" : "pdf"}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setStatus(`${fmt.toUpperCase()} downloaded.`, true);
    }catch(e){
      setStatus(`Download error: ${e.message}`, false);
    }
  }

  async function copyJson(){
    try{
      if (!lastAudit) return setStatus("Nothing to copy yet. Run an audit first.", false);
      const audit = lastAudit.audit || lastAudit;
      await navigator.clipboard.writeText(JSON.stringify(audit, null, 2));
      setStatus("JSON copied to clipboard.", true);
    }catch(e){
      setStatus(`Copy failed: ${e.message}`, false);
    }
  }

  // =========================
  // Rendering + Charts
  // =========================
  function renderAudit(payload){
    const auditId = payload.audit_id;
    const audit = payload.audit || {};
    const human_view = payload.human_view || audit.human_view || "‚Äî";

    const band = audit.feasibility_band || "‚Äî";
    const readiness = audit.readiness_score;
    const rog = audit.rog?.rog_score;

    auditIdEl.textContent = auditId || "‚Äî";
    bandText.textContent = `${band} (${audit.verdict || "‚Äî"})`;
    bandDot.style.background = bandColor(band);
    readinessEl.textContent = (readiness !== undefined && readiness !== null) ? Number(readiness).toFixed(3) : "‚Äî";
    rogEl.textContent = (rog !== undefined && rog !== null) ? rog : "‚Äî";

    humanViewEl.textContent = human_view || "‚Äî";
    ministerBriefEl.textContent = JSON.stringify(audit.minister_brief || {}, null, 2);
    donorComplianceEl.textContent = JSON.stringify(audit.donor_compliance || {}, null, 2);

    const memo = audit.memo || {};
    execVerdictEl.textContent = memo.executive_verdict ? String(memo.executive_verdict) : JSON.stringify(memo, null, 2);

    // KPI table
    const kpis = audit.kpis || {};
    const kpi_detail = audit.kpi_detail || {};
    const entries = Object.entries(kpis).sort((a,b) => (b[1]||0) - (a[1]||0));

    kpiTbody.innerHTML = "";
    for (const [domain, score] of entries){
      const tr = document.createElement("tr");
      const ev = kpi_detail?.[domain];
      const evShort = ev ? (ev.evidence_source || ev.evidence_snippet || ev.evidence_reference_id || "") : "";
      tr.innerHTML = `
        <td>${escapeHtml(domain)}</td>
        <td>${(score===null||score===undefined) ? "" : Number(score).toFixed(3)}</td>
        <td class="small muted">${escapeHtml(String(evShort).slice(0,140))}</td>
      `;
      kpiTbody.appendChild(tr);
    }

    // Stress table
    const stress = audit.stress_test || [];
    stressTbody.innerHTML = "";
    for (const s of stress){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(s.scenario||"")}</td>
        <td>${fmtNum(s.readiness_score, 4)}</td>
        <td>${escapeHtml(s.feasibility_band||"")}</td>
        <td>${escapeHtml(s.verdict||"")}</td>
        <td>${escapeHtml(String(s.rog_score ?? ""))}</td>
        <td>${fmtNum(s.fr, 4)}</td>
      `;
      stressTbody.appendChild(tr);
    }

    rawJsonEl.textContent = JSON.stringify(audit, null, 2);

    // Charts
    buildChartsFromAudit(audit);
  }

  function buildChartsFromAudit(audit){
    destroyCharts();

    // Chart.js not available (CSP blocked CDN etc.)
    if (typeof Chart === "undefined") {
      setStatus("Charts blocked (Chart.js not loaded). Fix CSP to allow cdn.jsdelivr.net or host Chart.js locally.", false);
      return;
    }

    // ---- KPI Bar (top 21) ----
    const kpis = audit.kpis || {};
    const kpiEntries = Object.entries(kpis)
      .map(([k,v]) => [k, Number(v)])
      .filter(([,v]) => Number.isFinite(v))
      .sort((a,b) => b[1] - a[1]);

    const kpiLabels = kpiEntries.map(([k]) => k);
    const kpiValues = kpiEntries.map(([,v]) => v);

    chartKpiBar = new Chart(el("chartKpiBar"), {
      type: "bar",
      data: {
        labels: kpiLabels,
        datasets: [{
          label: "KPI Score (0‚Äì1)",
          data: kpiValues
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { min: 0, max: 1 }
        }
      }
    });

    // ---- Stress Line (scenario readiness) ----
    const stress = Array.isArray(audit.stress_test) ? audit.stress_test : [];
    const sLabels = stress.map(s => s.scenario || "");
    const sValues = stress.map(s => {
      const v = Number(s.readiness_score);
      return Number.isFinite(v) ? v : null;
    });

    chartStressLine = new Chart(el("chartStressLine"), {
      type: "line",
      data: {
        labels: sLabels,
        datasets: [{
          label: "Readiness (0‚Äì1)",
          data: sValues,
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { min: 0, max: 1 } }
      }
    });

    // ---- Histogram of KPI scores ----
    const bins = 10;
    const counts = new Array(bins).fill(0);
    for (const v of kpiValues){
      const idx = Math.min(bins - 1, Math.max(0, Math.floor(v * bins)));
      counts[idx] += 1;
    }
    const histLabels = [];
    for (let i=0; i<bins; i++){
      const a = (i / bins).toFixed(1);
      const b = ((i+1)/bins).toFixed(1);
      histLabels.push(`${a}‚Äì${b}`);
    }

    chartKpiHist = new Chart(el("chartKpiHist"), {
      type: "bar",
      data: {
        labels: histLabels,
        datasets: [{
          label: "Count of KPIs",
          data: counts
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // =========================
  // Events
  // =========================
  btnPing.addEventListener("click", ping);
  btnRun.addEventListener("click", runAuditPaste);
  btnUpload.addEventListener("click", runAuditUpload);
  btnClear.addEventListener("click", () => {
    promptInput.value = "";
    fileInput.value = "";
    lastPrompt = "";
    lastAudit = null;
    clearOutput();
    setStatus("Cleared.", true);
  });

  btnPdf.addEventListener("click", () => downloadReport("pdf"));
  btnCsv.addEventListener("click", () => downloadReport("csv"));
  btnCopyJson.addEventListener("click", copyJson);

  // init
  loadTenants();
  ping();
  clearOutput();
})();
</script>

<!--
CSP NOTE (Render static _headers):
If charts do not show (Chart.js blocked), add cdn.jsdelivr.net to script-src, e.g.:

Content-Security-Policy: default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://infer-polis.onrender.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; frame-ancestors 'none';

If downloads fail due to blob restrictions, ensure:
- default-src allows 'self'
- connect-src includes your backend
-->

</body>
</html>
