
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infer-Polis 11.0 ‚Äî Policy Audit</title>
  <style>
    :root { --bg:#0b1220; --card:#0f1b33; --muted:#9fb0d0; --text:#e9f0ff; --line:#22345b; --good:#35c46a; --warn:#ffcc66; --bad:#ff5c5c; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ padding:18px 22px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;}
    header h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 22px 40px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media(min-width:980px){ .grid{ grid-template-columns: 420px 1fr; } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, select, textarea{
      width:100%; box-sizing:border-box; padding:10px 11px;
      border-radius:10px; border:1px solid #243a68; background:#09152d; color:var(--text);
      outline:none;
    }
    textarea{ min-height:170px; resize:vertical; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      cursor:pointer; border:1px solid #2b4782; background:#0a1b3d; color:var(--text);
      padding:10px 12px; border-radius:10px; font-weight:600;
    }
    .btn:hover{ border-color:#3c62b3; }
    .btn.primary{ background:#11346e; border-color:#3867c9; }
    .btn.dl{ background:#0f2b56; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#09152d; }
    .pill .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; }
    .muted{ color:var(--muted); }
    pre{
      background:#071127; border:1px solid #20335a; padding:10px; border-radius:12px; overflow:auto;
      white-space:pre-wrap; word-break:break-word;
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top; }
    th{ color:var(--muted); font-weight:600; }
    .small{ font-size:12px; }
    .two{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media(min-width:980px){ .two{ grid-template-columns:1fr 1fr; } }
    .err{ color:#ffb4b4; }
    .ok{ color:#b7ffc9; }
    .badge{ font-weight:700; }
  </style>
</head>
<body>
<header>
  <h1>Infer-Polis 11.0 ‚Äî Sovereign Governance Decision Engine</h1>
  <div class="row">
    <span class="pill"><span class="dot" id="dotLive" style="background:#666"></span><span id="liveText">Not checked</span></span>
    <span class="pill">Backend: <span class="badge" id="backendVer">‚Äî</span></span>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted small">API base</div>
          <div class="small"><code id="baseUrlLabel"></code></div>
        </div>
        <button class="btn" id="btnPing">Check Live</button>
      </div>

      <label>Tenant</label>
      <select id="tenantSelect"></select>

      <label>API Key (X-API-Key)</label>
      <input id="apiKey" placeholder="ipk_..." autocomplete="off"/>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="btnRun">Run Audit</button>
        <button class="btn" id="btnClear">Clear</button>
      </div>

      <label style="margin-top:14px;">Policy Prompt</label>
      <textarea id="prompt" placeholder="Paste policy text here..."></textarea>

      <div class="row" style="margin-top:12px;">
        <button class="btn dl" id="btnPdf" disabled>Download PDF</button>
        <button class="btn dl" id="btnCsv" disabled>Download CSV</button>
      </div>

      <div class="muted small" style="margin-top:10px;">
        Tip: Use <code>output_mode: both</code> so you get <code>human_view</code> + JSON.
      </div>

      <div id="status" class="small" style="margin-top:12px;"></div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="muted small">Latest Audit</div>
          <div class="small">audit_id: <code id="auditId">‚Äî</code></div>
        </div>
        <div class="row">
          <span class="pill"><span class="dot" id="bandDot" style="background:#666"></span><span id="bandText">‚Äî</span></span>
          <span class="pill">Readiness: <span class="badge" id="readiness">‚Äî</span></span>
          <span class="pill">RoG: <span class="badge" id="rog">‚Äî</span></span>
        </div>
      </div>

      <h3 style="margin:14px 0 6px; font-size:14px;">Policymaker View (human_view)</h3>
      <pre id="humanView">‚Äî</pre>

      <div class="two">
        <div>
          <h3 style="margin:10px 0 6px; font-size:14px;">Minister Brief</h3>
          <pre id="ministerBrief">‚Äî</pre>
        </div>
        <div>
          <h3 style="margin:10px 0 6px; font-size:14px;">Donor Compliance</h3>
          <pre id="donorCompliance">‚Äî</pre>
        </div>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Executive Verdict (Memo)</h3>
      <pre id="execVerdict">‚Äî</pre>

      <h3 style="margin:10px 0 6px; font-size:14px;">KPI Scores (21 domains)</h3>
      <div style="max-height:320px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
        <table id="kpiTable">
          <thead><tr><th>Domain</th><th>Score</th><th>Evidence</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Stress Tests</h3>
      <div style="max-height:260px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
        <table id="stressTable">
          <thead><tr><th>Scenario</th><th>Readiness</th><th>Band</th><th>Verdict</th><th>RoG</th><th>FR</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:10px 0 6px; font-size:14px;">Raw JSON (audit)</h3>
      <pre id="rawJson">‚Äî</pre>
    </div>
  </div>
</div>

<script>
(() => {
  const BASE_URL = "https://infer-polis.onrender.com";   // backend
  document.getElementById("baseUrlLabel").textContent = BASE_URL;

  const el = (id) => document.getElementById(id);

  const dotLive = el("dotLive");
  const liveText = el("liveText");
  const backendVer = el("backendVer");
  const tenantSelect = el("tenantSelect");
  const apiKeyInput = el("apiKey");
  const promptInput = el("prompt");

  const statusEl = el("status");
  const auditIdEl = el("auditId");
  const bandDot = el("bandDot");
  const bandText = el("bandText");
  const readinessEl = el("readiness");
  const rogEl = el("rog");

  const humanViewEl = el("humanView");
  const ministerBriefEl = el("ministerBrief");
  const donorComplianceEl = el("donorCompliance");
  const execVerdictEl = el("execVerdict");
  const rawJsonEl = el("rawJson");

  const kpiTbody = el("kpiTable").querySelector("tbody");
  const stressTbody = el("stressTable").querySelector("tbody");

  const btnRun = el("btnRun");
  const btnClear = el("btnClear");
  const btnPing = el("btnPing");
  const btnPdf = el("btnPdf");
  const btnCsv = el("btnCsv");

  let lastPrompt = "";
  let lastTenant = "";
  let lastApiKey = "";
  let lastAudit = null;

  function setStatus(msg, ok=true){
    statusEl.innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`;
  }

  function bandColor(b){
    if (b === "GREEN") return "var(--good)";
    if (b === "AMBER") return "var(--warn)";
    if (b === "RED") return "var(--bad)";
    return "#666";
  }

  async function ping(){
    try{
      const r = await fetch(`${BASE_URL}/`);
      const j = await r.json();
      const ver = j?.version || "unknown";
      backendVer.textContent = ver;
      dotLive.style.background = r.ok ? "var(--good)" : "var(--bad)";
      liveText.textContent = r.ok ? "Service live" : "Service issue";
      setStatus(`Backend OK: ${ver}`, true);
    }catch(e){
      dotLive.style.background = "var(--bad)";
      liveText.textContent = "Offline";
      setStatus(`Backend unreachable: ${e.message}`, false);
    }
  }

  async function loadTenants(){
    try{
      const r = await fetch(`${BASE_URL}/tenants`);
      const j = await r.json();
      const items = j?.tenants || [];
      tenantSelect.innerHTML = "";
      for (const t of items){
        const opt = document.createElement("option");
        opt.value = t.tenant_id;
        opt.textContent = `${t.label} (${t.tenant_id})`;
        tenantSelect.appendChild(opt);
      }
      tenantSelect.value = "public";
    }catch(e){
      tenantSelect.innerHTML = `<option value="public">üåç Public (public)</option>`;
    }
  }

  function clearOutput(){
    auditIdEl.textContent = "‚Äî";
    bandText.textContent = "‚Äî";
    bandDot.style.background = "#666";
    readinessEl.textContent = "‚Äî";
    rogEl.textContent = "‚Äî";
    humanViewEl.textContent = "‚Äî";
    ministerBriefEl.textContent = "‚Äî";
    donorComplianceEl.textContent = "‚Äî";
    execVerdictEl.textContent = "‚Äî";
    rawJsonEl.textContent = "‚Äî";
    kpiTbody.innerHTML = "";
    stressTbody.innerHTML = "";
    btnPdf.disabled = true;
    btnCsv.disabled = true;
    lastAudit = null;
  }

  async function runAudit(){
    const tenantId = tenantSelect.value;
    const apiKey = apiKeyInput.value.trim();
    const promptText = (promptInput.value || "").trim();

    if (!apiKey) return setStatus("API key required.", false);
    if (!promptText || promptText.length < 10) return setStatus("Prompt too short.", false);

    setStatus("Running audit‚Ä¶", true);
    clearOutput();

    lastPrompt = promptText;
    lastTenant = tenantId;
    lastApiKey = apiKey;

    try{
      const r = await fetch(`${BASE_URL}/policy/audit`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey,
          "X-Tenant-ID": tenantId
        },
        body: JSON.stringify({
          prompt: promptText,
          output_mode: "both"
        })
      });

      const j = await r.json();
      if (!r.ok || !j.ok){
        throw new Error(j?.detail ? JSON.stringify(j.detail) : (j?.error || "Audit failed"));
      }

      lastAudit = j;
      renderAudit(j);
      setStatus("Audit complete.", true);
      btnPdf.disabled = false;
      btnCsv.disabled = false;

    }catch(e){
      setStatus(`Audit error: ${e.message}`, false);
    }
  }

  function renderAudit(payload){
    const auditId = payload.audit_id;
    const audit = payload.audit || {};
    const human_view = payload.human_view || audit.human_view || "‚Äî";

    const band = audit.feasibility_band || "‚Äî";
    const readiness = audit.readiness_score;
    const rog = audit.rog?.rog_score;

    auditIdEl.textContent = auditId || "‚Äî";
    bandText.textContent = `${band} (${audit.verdict || "‚Äî"})`;
    bandDot.style.background = bandColor(band);
    readinessEl.textContent = (readiness !== undefined && readiness !== null) ? Number(readiness).toFixed(3) : "‚Äî";
    rogEl.textContent = (rog !== undefined && rog !== null) ? rog : "‚Äî";

    humanViewEl.textContent = human_view || "‚Äî";
    ministerBriefEl.textContent = JSON.stringify(audit.minister_brief || {}, null, 2);
    donorComplianceEl.textContent = JSON.stringify(audit.donor_compliance || {}, null, 2);

    const memo = audit.memo || {};
    execVerdictEl.textContent = memo.executive_verdict ? String(memo.executive_verdict) : JSON.stringify(memo, null, 2);

    // KPI table
    const kpis = audit.kpis || {};
    const kpi_detail = audit.kpi_detail || {};
    const entries = Object.entries(kpis).sort((a,b) => (b[1]||0) - (a[1]||0));
    kpiTbody.innerHTML = "";
    for (const [domain, score] of entries){
      const tr = document.createElement("tr");
      const ev = kpi_detail?.[domain];
      const evShort = ev ? (ev.evidence_source || ev.evidence_snippet || ev.evidence_reference_id || "") : "";
      tr.innerHTML = `
        <td>${escapeHtml(domain)}</td>
        <td>${(score===null||score===undefined) ? "" : Number(score).toFixed(3)}</td>
        <td class="small muted">${escapeHtml(String(evShort).slice(0,120))}</td>
      `;
      kpiTbody.appendChild(tr);
    }

    // Stress table
    const stress = audit.stress_test || [];
    stressTbody.innerHTML = "";
    for (const s of stress){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(s.scenario||"")}</td>
        <td>${fmtNum(s.readiness_score, 4)}</td>
        <td>${escapeHtml(s.feasibility_band||"")}</td>
        <td>${escapeHtml(s.verdict||"")}</td>
        <td>${escapeHtml(String(s.rog_score ?? ""))}</td>
        <td>${fmtNum(s.fr, 4)}</td>
      `;
      stressTbody.appendChild(tr);
    }

    rawJsonEl.textContent = JSON.stringify(audit, null, 2);
  }

  function fmtNum(x, d){
    if (x === null || x === undefined) return "";
    const n = Number(x);
    if (Number.isNaN(n)) return String(x);
    return n.toFixed(d);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function downloadReport(fmt){
    const tenantId = lastTenant || tenantSelect.value;
    const apiKey = lastApiKey || apiKeyInput.value.trim();
    const promptText = lastPrompt || (promptInput.value || "").trim();

    if (!apiKey) return setStatus("API key required.", false);
    if (!promptText) return setStatus("Prompt required for report.", false);

    try{
      setStatus(`Generating ${fmt.toUpperCase()}‚Ä¶`, true);
      const r = await fetch(`${BASE_URL}/report/generate?format=${encodeURIComponent(fmt)}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-Key": apiKey,
          "X-Tenant-ID": tenantId
        },
        body: JSON.stringify({ prompt: promptText })
      });
      if (!r.ok) throw new Error("Report generation failed");

      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `infer-polis-report.${fmt === "csv" ? "csv" : "pdf"}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setStatus(`${fmt.toUpperCase()} downloaded.`, true);
    }catch(e){
      setStatus(`Download error: ${e.message}`, false);
    }
  }

  btnPing.addEventListener("click", ping);
  btnRun.addEventListener("click", runAudit);
  btnClear.addEventListener("click", () => { promptInput.value=""; clearOutput(); setStatus("Cleared.", true); });
  btnPdf.addEventListener("click", () => downloadReport("pdf"));
  btnCsv.addEventListener("click", () => downloadReport("csv"));

  // init
  loadTenants();
  ping();
  clearOutput();
})();
</script>
</body>
</html>
